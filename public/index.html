<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ProspectR SA</title>
  <style>
    :root {
      --blue:    #1a56db;
      --dark:    #1e3a5f;
      --green:   #10b981;
      --amber:   #f59e0b;
      --red:     #ef4444;
      --gray50:  #f9fafb;
      --gray100: #f3f4f6;
      --gray200: #e5e7eb;
      --gray400: #9ca3af;
      --gray600: #4b5563;
      --gray800: #1f2937;
      --white:   #ffffff;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--gray100); color: var(--gray800); }

    /* Layout */
    .layout { display: flex; min-height: 100vh; }
    .sidebar {
      width: 220px; background: var(--dark); color: #cdd6e8; flex-shrink: 0;
      display: flex; flex-direction: column; padding: 0;
    }
    .sidebar-logo {
      padding: 20px 18px 14px; font-size: 1.2rem; font-weight: 700;
      color: #fff; letter-spacing: .5px; border-bottom: 1px solid #2d4d73;
    }
    .sidebar-logo span { color: #60a5fa; }
    .sidebar nav { flex: 1; padding: 10px 0; }
    .nav-item {
      display: flex; align-items: center; gap: 10px; padding: 11px 18px;
      cursor: pointer; font-size: .9rem; transition: background .15s;
      border-left: 3px solid transparent;
    }
    .nav-item:hover   { background: rgba(255,255,255,.07); }
    .nav-item.active  { background: rgba(26,86,219,.25); border-left-color: #60a5fa; color: #fff; }
    .nav-icon { font-size: 1.1rem; width: 22px; text-align:center; }
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .topbar {
      background: var(--white); border-bottom: 1px solid var(--gray200);
      padding: 14px 24px; display: flex; align-items: center; justify-content: space-between;
    }
    .topbar h1 { font-size: 1.1rem; font-weight: 600; color: var(--dark); }
    .topbar-actions { display: flex; gap: 10px; align-items: center; }
    .content { flex: 1; overflow-y: auto; padding: 24px; }
    .page { display: none; }
    .page.active { display: block; }

    /* Cards */
    .stat-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card {
      background: var(--white); border-radius: 10px; padding: 18px 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,.08); border-top: 3px solid var(--blue);
    }
    .stat-card.green { border-top-color: var(--green); }
    .stat-card.amber { border-top-color: var(--amber); }
    .stat-card.red   { border-top-color: var(--red); }
    .stat-card .label { font-size: .78rem; color: var(--gray400); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px; }
    .stat-card .value { font-size: 1.8rem; font-weight: 700; color: var(--dark); }
    .stat-card .sub   { font-size: .78rem; color: var(--gray400); margin-top: 4px; }

    /* Buttons */
    .btn {
      padding: 8px 16px; border-radius: 6px; font-size: .85rem; font-weight: 500;
      cursor: pointer; border: none; transition: opacity .15s, transform .1s;
      display: inline-flex; align-items: center; gap: 6px; text-decoration: none;
    }
    .btn:hover  { opacity: .88; }
    .btn:active { transform: scale(.97); }
    .btn-primary { background: var(--blue); color: #fff; }
    .btn-success { background: var(--green); color: #fff; }
    .btn-danger  { background: var(--red); color: #fff; }
    .btn-ghost   { background: transparent; border: 1px solid var(--gray200); color: var(--gray600); }
    .btn-sm { padding: 5px 11px; font-size: .8rem; }

    /* Filters */
    .filters {
      background: var(--white); border-radius: 10px; padding: 16px 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,.06); margin-bottom: 18px;
      display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end;
    }
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-group label { font-size: .75rem; color: var(--gray600); font-weight: 500; }
    .filter-group select, .filter-group input {
      padding: 7px 10px; border: 1px solid var(--gray200); border-radius: 6px;
      font-size: .85rem; color: var(--gray800); background: var(--white);
      min-width: 130px;
    }
    .filter-group select:focus, .filter-group input:focus { outline: none; border-color: var(--blue); }

    /* Table */
    .table-wrap {
      background: var(--white); border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,.06); overflow: hidden;
    }
    .table-header {
      padding: 14px 18px; display: flex; align-items: center;
      justify-content: space-between; border-bottom: 1px solid var(--gray100);
    }
    .table-header .count { font-size: .85rem; color: var(--gray400); }
    table { width: 100%; border-collapse: collapse; font-size: .85rem; }
    thead th {
      padding: 10px 12px; text-align: left; font-size: .75rem; font-weight: 600;
      color: var(--gray600); text-transform: uppercase; letter-spacing: .4px;
      background: var(--gray50); border-bottom: 1px solid var(--gray200);
    }
    tbody tr { border-bottom: 1px solid var(--gray100); transition: background .1s; }
    tbody tr:hover { background: var(--gray50); }
    tbody td { padding: 10px 12px; color: var(--gray800); vertical-align: middle; }
    .url-cell a { color: var(--blue); text-decoration: none; font-size: .8rem; word-break: break-all; }
    .url-cell a:hover { text-decoration: underline; }
    .no-url { color: var(--red); font-size: .78rem; }

    /* Score badge */
    .score-badge {
      display: inline-flex; align-items: center; justify-content: center;
      width: 36px; height: 36px; border-radius: 50%; font-weight: 700; font-size: .85rem; color: #fff;
    }
    .score-high   { background: var(--red); }
    .score-medium { background: var(--amber); }
    .score-low    { background: var(--green); }
    .score-none   { background: var(--gray200); color: var(--gray400); }

    /* Prospect tag */
    .tag {
      display: inline-block; padding: 2px 8px; border-radius: 99px;
      font-size: .72rem; font-weight: 600; text-transform: uppercase; letter-spacing: .3px;
    }
    .tag-high       { background: #fee2e2; color: #b91c1c; }
    .tag-medium     { background: #fef9c3; color: #92400e; }
    .tag-low        { background: #d1fae5; color: #065f46; }
    .tag-no_website { background: #ede9fe; color: #5b21b6; }

    /* Issues list */
    .issues { font-size: .75rem; color: var(--gray600); }
    .issues li { list-style: disc; margin-left: 14px; }

    /* Pagination */
    .pagination { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 16px; }
    .page-btn { padding: 6px 12px; border-radius: 5px; border: 1px solid var(--gray200); cursor: pointer; background: var(--white); font-size: .82rem; }
    .page-btn:hover   { background: var(--gray100); }
    .page-btn.current { background: var(--blue); color: #fff; border-color: var(--blue); }
    .page-info { font-size: .82rem; color: var(--gray400); }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.45);
      display: flex; align-items: center; justify-content: center; z-index: 100;
    }
    .modal-overlay.hidden { display: none; }
    .modal {
      background: var(--white); border-radius: 12px; padding: 28px 32px;
      width: 100%; max-width: 480px; box-shadow: 0 20px 60px rgba(0,0,0,.2);
    }
    .modal h2 { font-size: 1.1rem; font-weight: 700; margin-bottom: 18px; color: var(--dark); }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: .82rem; font-weight: 500; color: var(--gray600); margin-bottom: 5px; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 9px 12px; border: 1px solid var(--gray200);
      border-radius: 6px; font-size: .88rem; color: var(--gray800);
    }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--blue); }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .checkbox-group { display: flex; flex-direction: column; gap: 8px; }
    .checkbox-group label { display: flex; align-items: center; gap: 8px; font-size: .85rem; cursor: pointer; font-weight: normal; }

    /* Jobs list */
    .jobs-list { display: flex; flex-direction: column; gap: 10px; margin-top: 16px; }
    .job-card {
      background: var(--white); border-radius: 8px; padding: 14px 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,.06); display: flex; align-items: center; gap: 14px;
    }
    .job-status { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .job-status.pending   { background: var(--gray400); }
    .job-status.running   { background: var(--amber); animation: pulse 1s infinite; }
    .job-status.completed { background: var(--green); }
    .job-status.failed    { background: var(--red); }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
    .job-info { flex: 1; }
    .job-info .title { font-size: .88rem; font-weight: 600; }
    .job-info .meta  { font-size: .75rem; color: var(--gray400); margin-top: 2px; }
    .job-count { font-size: 1.2rem; font-weight: 700; color: var(--dark); }

    /* Bulk scrape checks */
    .bulk-checks {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 6px; max-height: 200px; overflow-y: auto; padding: 8px;
      border: 1px solid var(--gray200); border-radius: 6px; background: var(--gray50);
    }
    .bulk-checks label { display: flex; align-items: center; gap: 6px; font-size: .82rem; cursor: pointer; }
    .bulk-toggle-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .estimate-badge {
      display: inline-block; background: #eff6ff; color: var(--blue);
      border: 1px solid #bfdbfe; border-radius: 6px; padding: 4px 10px;
      font-size: .82rem; font-weight: 600; margin-top: 10px;
    }

    /* Settings */
    .settings-card {
      background: var(--white); border-radius: 10px; padding: 24px 28px;
      box-shadow: 0 1px 3px rgba(0,0,0,.06); max-width: 600px;
    }
    .settings-card h2 { font-size: 1rem; font-weight: 700; margin-bottom: 20px; color: var(--dark); }
    .settings-sources { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 6px; }
    .source-toggle {
      display: flex; align-items: center; gap: 7px; padding: 7px 12px;
      border: 1px solid var(--gray200); border-radius: 6px; cursor: pointer;
      font-size: .83rem; transition: all .15s;
    }
    .source-toggle.active { border-color: var(--blue); background: #eff6ff; color: var(--blue); font-weight: 600; }

    /* Toast */
    #toast {
      position: fixed; bottom: 24px; right: 24px; background: var(--dark);
      color: #fff; padding: 12px 20px; border-radius: 8px; font-size: .85rem;
      box-shadow: 0 8px 24px rgba(0,0,0,.2); opacity: 0; transition: opacity .3s;
      z-index: 200; pointer-events: none; max-width: 320px;
    }
    #toast.show { opacity: 1; }

    /* Loading spinner */
    .spinner {
      display: inline-block; width: 18px; height: 18px;
      border: 2px solid rgba(255,255,255,.3); border-top-color: #fff;
      border-radius: 50%; animation: spin .6s linear infinite; vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-row td { text-align: center; padding: 40px; color: var(--gray400); }

    /* Responsive tweaks */
    @media(max-width:768px) { .sidebar{width:60px;} .sidebar-logo span,.nav-item span{display:none;} }
  </style>
</head>
<body>
<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">Prospect<span>R SA</span></div>
    <nav>
      <div class="nav-item active" onclick="showPage('dashboard',this)">
        <span class="nav-icon">üìä</span><span>Dashboard</span>
      </div>
      <div class="nav-item" onclick="showPage('prospects',this)">
        <span class="nav-icon">üè¢</span><span>Prospects</span>
      </div>
      <div class="nav-item" onclick="showPage('scrape',this)">
        <span class="nav-icon">üîç</span><span>Scrape</span>
      </div>
      <div class="nav-item" onclick="showPage('settings',this)">
        <span class="nav-icon">‚öôÔ∏è</span><span>Settings</span>
      </div>
    </nav>
  </aside>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <h1 id="page-title">Dashboard</h1>
      <div class="topbar-actions">
        <button class="btn btn-ghost btn-sm" onclick="exportPdf()">‚¨á Export PDF</button>
        <button class="btn btn-primary btn-sm" onclick="openScrapeModal()">+ New Scrape</button>
      </div>
    </div>

    <div class="content">
      <!-- Dashboard -->
      <div id="page-dashboard" class="page active">
        <div class="stat-cards" id="stat-cards">
          <div class="stat-card"><div class="label">Total Businesses</div><div class="value" id="stat-total">‚Äî</div></div>
          <div class="stat-card red"><div class="label">High Prospects</div><div class="value" id="stat-high">‚Äî</div><div class="sub">Score ‚â• 70</div></div>
          <div class="stat-card amber"><div class="label">Medium Prospects</div><div class="value" id="stat-medium">‚Äî</div><div class="sub">Score 40‚Äì69</div></div>
          <div class="stat-card"><div class="label">No Website</div><div class="value" id="stat-no-website">‚Äî</div></div>
          <div class="stat-card green"><div class="label">Audited</div><div class="value" id="stat-audited">‚Äî</div></div>
          <div class="stat-card amber"><div class="label">Pending Audit</div><div class="value" id="stat-pending">‚Äî</div></div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
          <div class="table-wrap">
            <div class="table-header"><strong>Top Cities</strong></div>
            <table id="cities-table">
              <thead><tr><th>City</th><th>Count</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="table-wrap">
            <div class="table-header"><strong>Sources</strong></div>
            <table id="sources-table">
              <thead><tr><th>Source</th><th>Count</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="table-wrap">
          <div class="table-header"><strong>Recent Scrape Jobs</strong></div>
          <div class="jobs-list" id="jobs-list" style="padding:12px;"></div>
        </div>
      </div>

      <!-- Prospects Table -->
      <div id="page-prospects" class="page">
        <div class="filters">
          <div class="filter-group">
            <label>Search</label>
            <input type="text" id="f-search" placeholder="Business name‚Ä¶" oninput="debounceFilter()" />
          </div>
          <div class="filter-group">
            <label>City</label>
            <input type="text" id="f-city" placeholder="e.g. Cape Town" oninput="debounceFilter()" />
          </div>
          <div class="filter-group">
            <label>Province</label>
            <select id="f-province" onchange="loadBusinesses()">
              <option value="">All Provinces</option>
              <option>Western Cape</option><option>Gauteng</option><option>KwaZulu-Natal</option>
              <option>Eastern Cape</option><option>Limpopo</option><option>Mpumalanga</option>
              <option>North West</option><option>Free State</option><option>Northern Cape</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Source</label>
            <select id="f-source" onchange="loadBusinesses()">
              <option value="">All Sources</option>
              <option value="yellow_pages">Yellow Pages</option>
              <option value="brabys">Brabys</option>
              <option value="google_places">Google Places</option>
              <option value="cipc">CIPC</option>
              <option value="manual">Manual</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Quality</label>
            <select id="f-quality" onchange="loadBusinesses()">
              <option value="">All</option>
              <option value="no_website">No Website</option>
              <option value="high">High (‚â•70)</option>
              <option value="medium">Medium (40-69)</option>
              <option value="low">Low (&lt;40)</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Website</label>
            <select id="f-website" onchange="loadBusinesses()">
              <option value="">All</option>
              <option value="has">Has Website</option>
              <option value="none">‚úï No Website</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Min Score</label>
            <input type="number" id="f-min-score" placeholder="0‚Äì100" min="0" max="100" style="width:90px;" oninput="debounceFilter()" />
          </div>
          <button class="btn btn-ghost btn-sm" style="margin-top:18px" onclick="clearFilters()">Clear</button>
          <button class="btn btn-success btn-sm" style="margin-top:18px" onclick="auditAll()">‚ñ∂ Audit All Pending</button>
          <button class="btn btn-primary btn-sm" style="margin-top:18px" onclick="exportPdf()">‚¨á PDF</button>
        </div>

        <div class="table-wrap">
          <div class="table-header">
            <span class="count" id="biz-count">Loading‚Ä¶</span>
            <div style="display:flex;gap:8px;">
              <button class="btn btn-ghost btn-sm" onclick="loadBusinesses()">‚Üª Refresh</button>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Business</th>
                <th>City</th>
                <th>Category</th>
                <th>Phone</th>
                <th>Website</th>
                <th>Score</th>
                <th>Quality</th>
                <th>Issues</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="biz-tbody">
              <tr class="loading-row"><td colspan="9">Loading‚Ä¶</td></tr>
            </tbody>
          </table>
          <div class="pagination" id="pagination"></div>
        </div>
      </div>

      <!-- Scrape Page -->
      <div id="page-scrape" class="page">
        <div style="max-width:640px;">

          <!-- Single scrape -->
          <div class="settings-card" style="margin-bottom:20px;">
            <h2>üîç Single Scrape</h2>
            <div class="form-group">
              <label>Category / Business Type</label>
              <input type="text" id="sc-category" value="restaurant" placeholder="e.g. plumber, restaurant, accountant" />
            </div>
            <div class="form-group">
              <label>Location / City</label>
              <input type="text" id="sc-location" value="Cape Town" />
            </div>
            <div class="form-group">
              <label>Sources</label>
              <div class="checkbox-group" id="sc-sources">
                <label><input type="checkbox" value="yellow_pages" checked /> Yellow Pages SA</label>
                <label><input type="checkbox" value="brabys" /> Brabys SA</label>
                <label><input type="checkbox" value="google_places" /> Google Places (API key required)</label>
                <label><input type="checkbox" value="cipc" /> CIPC Registry</label>
              </div>
            </div>
            <button class="btn btn-primary" onclick="runScrape()"><span id="scrape-btn-text">‚ñ∂ Start Scrape</span></button>
          </div>

          <!-- Bulk scrape -->
          <div class="settings-card" style="margin-bottom:20px; max-width:640px;">
            <h2>‚ö° Bulk Scrape ‚Äî Hundreds of Businesses</h2>
            <p style="font-size:.83rem;color:var(--gray600);margin-bottom:16px;">
              Scrapes Yellow Pages across multiple cities &amp; categories simultaneously.
              Skips per-business detail fetching so each city√ócategory combination takes ~2s instead of ~30s.
              Phone/website data is fetched later via audit.
            </p>

            <div class="form-group">
              <label>Cities
                <div class="bulk-toggle-row" style="margin-top:6px;">
                  <button class="btn btn-ghost btn-sm" onclick="toggleAll('bulk-cities', true)">All</button>
                  <button class="btn btn-ghost btn-sm" onclick="toggleAll('bulk-cities', false)">None</button>
                  <button class="btn btn-ghost btn-sm" onclick="toggleAll('bulk-cities', true, 5)">Top 5</button>
                  <button class="btn btn-ghost btn-sm" onclick="toggleAll('bulk-cities', true, 10)">Top 10</button>
                </div>
              </label>
              <div class="bulk-checks" id="bulk-cities" onchange="updateBulkEstimate()">
                <label><input type="checkbox" value="Cape Town" checked /> Cape Town</label>
                <label><input type="checkbox" value="Johannesburg" checked /> Johannesburg</label>
                <label><input type="checkbox" value="Pretoria" checked /> Pretoria</label>
                <label><input type="checkbox" value="Durban" checked /> Durban</label>
                <label><input type="checkbox" value="Port Elizabeth" checked /> Port Elizabeth</label>
                <label><input type="checkbox" value="Bloemfontein" /> Bloemfontein</label>
                <label><input type="checkbox" value="East London" /> East London</label>
                <label><input type="checkbox" value="Polokwane" /> Polokwane</label>
                <label><input type="checkbox" value="Nelspruit" /> Nelspruit</label>
                <label><input type="checkbox" value="George" /> George</label>
                <label><input type="checkbox" value="Rustenburg" /> Rustenburg</label>
                <label><input type="checkbox" value="Pietermaritzburg" /> Pietermaritzburg</label>
                <label><input type="checkbox" value="Kimberley" /> Kimberley</label>
                <label><input type="checkbox" value="Witbank" /> Witbank</label>
                <label><input type="checkbox" value="Welkom" /> Welkom</label>
                <label><input type="checkbox" value="Stellenbosch" /> Stellenbosch</label>
                <label><input type="checkbox" value="Paarl" /> Paarl</label>
                <label><input type="checkbox" value="Knysna" /> Knysna</label>
                <label><input type="checkbox" value="Mossel Bay" /> Mossel Bay</label>
                <label><input type="checkbox" value="Worcester" /> Worcester</label>
              </div>
            </div>

            <div class="form-group" style="margin-top:14px;">
              <label>Business Categories
                <div class="bulk-toggle-row" style="margin-top:6px;">
                  <button class="btn btn-ghost btn-sm" onclick="toggleAll('bulk-cats', true)">All</button>
                  <button class="btn btn-ghost btn-sm" onclick="toggleAll('bulk-cats', false)">None</button>
                </div>
              </label>
              <div class="bulk-checks" id="bulk-cats" onchange="updateBulkEstimate()">
                <label><input type="checkbox" value="plumber" checked /> Plumber</label>
                <label><input type="checkbox" value="electrician" checked /> Electrician</label>
                <label><input type="checkbox" value="accountant" checked /> Accountant</label>
                <label><input type="checkbox" value="attorney" checked /> Attorney</label>
                <label><input type="checkbox" value="dentist" checked /> Dentist</label>
                <label><input type="checkbox" value="doctor" /> Doctor</label>
                <label><input type="checkbox" value="salon" checked /> Salon</label>
                <label><input type="checkbox" value="mechanic" checked /> Mechanic</label>
                <label><input type="checkbox" value="builder" /> Builder</label>
                <label><input type="checkbox" value="photographer" /> Photographer</label>
                <label><input type="checkbox" value="florist" /> Florist</label>
                <label><input type="checkbox" value="bakery" /> Bakery</label>
                <label><input type="checkbox" value="cleaning service" /> Cleaning</label>
                <label><input type="checkbox" value="landscaping" /> Landscaping</label>
                <label><input type="checkbox" value="pest control" /> Pest Control</label>
                <label><input type="checkbox" value="locksmith" /> Locksmith</label>
                <label><input type="checkbox" value="estate agent" /> Estate Agent</label>
                <label><input type="checkbox" value="physiotherapist" /> Physio</label>
                <label><input type="checkbox" value="optometrist" /> Optometrist</label>
                <label><input type="checkbox" value="gym" /> Gym</label>
                <label><input type="checkbox" value="guesthouse" /> Guesthouse</label>
                <label><input type="checkbox" value="catering" /> Catering</label>
                <label><input type="checkbox" value="wedding venue" /> Wedding Venue</label>
                <label><input type="checkbox" value="printer" /> Printer</label>
                <label><input type="checkbox" value="insurance broker" /> Insurance</label>
                <label><input type="checkbox" value="restaurant" /> Restaurant</label>
                <label><input type="checkbox" value="hardware store" /> Hardware</label>
                <label><input type="checkbox" value="furniture store" /> Furniture</label>
                <label><input type="checkbox" value="pharmacist" /> Pharmacy</label>
              </div>
            </div>

            <div class="form-group" style="margin-top:14px;">
              <label>Pages per combination (10 results/page)</label>
              <select id="bulk-pages" onchange="updateBulkEstimate()" style="width:120px;">
                <option value="1">1 page (~10)</option>
                <option value="2" selected>2 pages (~20)</option>
                <option value="3">3 pages (~30)</option>
                <option value="5">5 pages (~50)</option>
              </select>
            </div>

            <div id="bulk-estimate" class="estimate-badge">Estimated: ~560 businesses</div>

            <div style="margin-top:16px;display:flex;gap:10px;align-items:center;">
              <button class="btn btn-success" onclick="runBulkScrape()"><span id="bulk-btn-text">‚ö° Start Bulk Scrape</span></button>
              <button class="btn btn-secondary" onclick="runBackfill()" title="Re-scrape existing businesses to fill in missing phone numbers and websites"><span id="backfill-btn-text">üìû Backfill Phone &amp; Website</span></button>
              <span style="font-size:.78rem;color:var(--gray400);">Runs in background ¬∑ Prospects auto-refresh when done</span>
            </div>
          </div>
        </div>

        <div class="table-wrap" style="max-width:700px;">
          <div class="table-header"><strong>Recent Scrape Jobs</strong><button class="btn btn-ghost btn-sm" onclick="loadJobs('scrape-jobs-list')">‚Üª</button></div>
          <div class="jobs-list" id="scrape-jobs-list" style="padding:12px;"></div>
        </div>
      </div>

      <!-- Settings -->
      <div id="page-settings" class="page">
        <div class="settings-card">
          <h2>‚öôÔ∏è Settings</h2>
          <div class="form-group">
            <label>Google Places API Key</label>
            <input type="password" id="s-google-key" placeholder="AIza‚Ä¶" />
            <small style="color:var(--gray400);font-size:.75rem;">Get one at <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></small>
          </div>
          <div class="form-group">
            <label>Default Province</label>
            <select id="s-province">
              <option>Western Cape</option><option>Gauteng</option><option>KwaZulu-Natal</option>
              <option>Eastern Cape</option><option>Limpopo</option><option>Mpumalanga</option>
              <option>North West</option><option>Free State</option><option>Northern Cape</option>
            </select>
          </div>
          <div class="form-group">
            <label>Default City</label>
            <input type="text" id="s-city" placeholder="Cape Town" />
          </div>
          <div class="form-group">
            <label>Default Category</label>
            <input type="text" id="s-category" placeholder="restaurant" />
          </div>
          <div class="form-group">
            <label>Audit Concurrency (parallel audits)</label>
            <input type="number" id="s-concurrency" min="1" max="20" value="5" style="width:80px;" />
          </div>
          <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scrape Modal (quick access) -->
<div class="modal-overlay hidden" id="scrape-modal">
  <div class="modal">
    <h2>üîç New Scrape Job</h2>
    <div class="form-group">
      <label>Category</label>
      <input type="text" id="m-category" value="restaurant" />
    </div>
    <div class="form-group">
      <label>Location</label>
      <input type="text" id="m-location" value="Cape Town" />
    </div>
    <div class="form-group">
      <label>Sources</label>
      <div class="checkbox-group" id="m-sources">
        <label><input type="checkbox" value="yellow_pages" checked /> Yellow Pages SA</label>
        <label><input type="checkbox" value="brabys" checked /> Brabys</label>
        <label><input type="checkbox" value="google_places" /> Google Places</label>
        <label><input type="checkbox" value="cipc" /> CIPC</label>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeScrapeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="runModalScrape()">‚ñ∂ Start</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
  const API = '/api';
  let currentPage = 0;
  const PAGE_SIZE = 50;
  let filterTimer = null;
  let jobPollTimer = null;

  // ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showPage(name, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('page-' + name).classList.add('active');
    el.classList.add('active');
    const titles = { dashboard:'Dashboard', prospects:'Prospects', scrape:'Scrape Jobs', settings:'Settings' };
    document.getElementById('page-title').textContent = titles[name] || name;
    if (name === 'dashboard')  { loadStats(); loadJobs(); }
    if (name === 'prospects')  { loadBusinesses(); }
    if (name === 'scrape')     { loadJobs('scrape-jobs-list'); }
    if (name === 'settings')   { loadSettings(); }
  }

  // ‚îÄ‚îÄ API helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function api(path, opts = {}) {
    const res = await fetch(API + path, {
      headers: { 'Content-Type': 'application/json', ...opts.headers },
      ...opts
    });
    if (!res.ok) throw new Error(await res.text());
    if (res.headers.get('content-type')?.includes('pdf')) return res.blob();
    return res.json();
  }

  // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toast(msg, duration = 3000) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), duration);
  }

  // ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadStats() {
    try {
      const s = await api('/businesses/stats');
      document.getElementById('stat-total').textContent    = s.total.toLocaleString();
      document.getElementById('stat-high').textContent     = s.high_prospects.toLocaleString();
      document.getElementById('stat-medium').textContent   = s.medium_prospects.toLocaleString();
      document.getElementById('stat-no-website').textContent = s.no_website.toLocaleString();
      document.getElementById('stat-audited').textContent  = s.audited.toLocaleString();
      document.getElementById('stat-pending').textContent  = s.needs_audit.toLocaleString();

      // Cities table
      const ctbody = document.querySelector('#cities-table tbody');
      ctbody.innerHTML = Object.entries(s.cities).map(([c,n]) =>
        `<tr><td>${c||'Unknown'}</td><td><strong>${n}</strong></td></tr>`).join('');

      // Sources table
      const stbody = document.querySelector('#sources-table tbody');
      const sourceNames = { yellow_pages:'Yellow Pages', brabys:'Brabys', google_places:'Google Places', cipc:'CIPC', manual:'Manual' };
      stbody.innerHTML = Object.entries(s.sources).map(([s,n]) =>
        `<tr><td>${sourceNames[s]||s}</td><td><strong>${n}</strong></td></tr>`).join('');
    } catch(e) { console.error('Stats error', e); }
  }

  async function loadJobs(targetId = 'jobs-list') {
    try {
      const jobs = await api('/scrape_jobs');
      const el = document.getElementById(targetId);
      if (!jobs.length) { el.innerHTML = '<p style="color:var(--gray400);font-size:.85rem;padding:8px 0;">No scrape jobs yet.</p>'; return; }

      el.innerHTML = jobs.slice(0, 8).map(j => `
        <div class="job-card">
          <div class="job-status ${j.status}"></div>
          <div class="job-info">
            <div class="title">${sourceLabel(j.source)} ‚Äî ${j.category} in ${j.location}</div>
            <div class="meta">${j.status.toUpperCase()} ¬∑ ${timeAgo(j.created_at)}${j.error_message ? ' ¬∑ <span style="color:var(--red)">'+esc(j.error_message)+'</span>' : ''}</div>
          </div>
          <div class="job-count">${j.results_count > 0 ? j.results_count + ' found' : j.status === 'running' ? '<span class="spinner"></span>' : ''}</div>
        </div>`).join('');

      // Auto-poll if any jobs are running; reload Prospects + stats when they finish
      const anyRunning = jobs.some(j => j.status === 'running' || j.status === 'pending');
      clearTimeout(jobPollTimer);
      if (anyRunning) {
        jobPollTimer = setTimeout(() => {
          loadJobs(targetId);
          loadStats();
        }, 3000);
      } else if (window._hadRunningJobs) {
        // Jobs just finished ‚Äî refresh Prospects if it's visible
        loadStats();
        if (document.getElementById('page-prospects')?.classList.contains('active')) {
          loadBusinesses();
        }
      }
      window._hadRunningJobs = anyRunning;
    } catch(e) { console.error('Jobs error', e); }
  }

  // ‚îÄ‚îÄ Prospects ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function debounceFilter() {
    clearTimeout(filterTimer);
    filterTimer = setTimeout(() => loadBusinesses(), 400);
  }

  function clearFilters() {
    ['f-search','f-city','f-min-score'].forEach(id => document.getElementById(id).value = '');
    ['f-province','f-source','f-quality','f-website'].forEach(id => document.getElementById(id).value = '');
    loadBusinesses();
  }

  async function loadBusinesses(page = 0) {
    currentPage = page;
    const params = new URLSearchParams();
    const search   = document.getElementById('f-search')?.value.trim();
    const city     = document.getElementById('f-city')?.value.trim();
    const province = document.getElementById('f-province')?.value;
    const source   = document.getElementById('f-source')?.value;
    const quality  = document.getElementById('f-quality')?.value;
    const website  = document.getElementById('f-website')?.value;
    const minScore = document.getElementById('f-min-score')?.value;

    if (search)   params.append('search', search);
    if (city)     params.append('city', city);
    if (province) params.append('province', province);
    if (source)   params.append('source', source);
    if (quality)  params.append('quality', quality);
    if (website)  params.append('website', website);
    if (minScore) params.append('min_score', minScore);
    params.append('offset', page * PAGE_SIZE);
    params.append('limit',  PAGE_SIZE);

    const tbody = document.getElementById('biz-tbody');
    tbody.innerHTML = '<tr class="loading-row"><td colspan="9"><span class="spinner" style="border-color:rgba(0,0,0,.15);border-top-color:var(--blue);"></span> Loading‚Ä¶</td></tr>';

    try {
      const data = await api('/businesses?' + params.toString());
      document.getElementById('biz-count').textContent = `${data.total.toLocaleString()} businesses`;
      renderBusinesses(data.businesses);
      renderPagination(data.total, page);
    } catch(e) {
      tbody.innerHTML = `<tr class="loading-row"><td colspan="9" style="color:var(--red)">Error: ${esc(e.message)}</td></tr>`;
    }
  }

  function renderBusinesses(list) {
    const tbody = document.getElementById('biz-tbody');
    if (!list.length) {
      tbody.innerHTML = '<tr class="loading-row"><td colspan="9">No businesses found</td></tr>';
      return;
    }
    tbody.innerHTML = list.map(b => {
      const a = b.audit;
      const scoreHtml = a
        ? `<div class="score-badge ${scoreClass(a.score)}">${a.score}</div>`
        : `<div class="score-badge score-none">?</div>`;
      const qualityHtml = `<span class="tag tag-${b.prospect_quality}">${b.prospect_quality.replace('_',' ')}</span>`;
      const urlHtml = b.website_url
        ? `<div class="url-cell"><a href="${esc(b.website_url)}" target="_blank" rel="noopener">${esc(truncate(b.website_url,30))}</a></div>`
        : `<span class="no-url">‚úó No website</span>`;
      const issues = a?.issues?.length
        ? `<ul class="issues">${a.issues.slice(0,3).map(i=>`<li>${esc(i)}</li>`).join('')}</ul>`
        : '<span style="color:var(--gray400);font-size:.75rem;">‚Äî</span>';
      return `<tr>
        <td><strong>${esc(b.name)}</strong><br><small style="color:var(--gray400)">${esc(b.source||'')}</small></td>
        <td>${esc(b.city||'')}</td>
        <td>${esc(b.category||'')}</td>
        <td style="white-space:nowrap">${esc(b.phone||'‚Äî')}</td>
        <td>${urlHtml}</td>
        <td style="text-align:center">${scoreHtml}</td>
        <td>${qualityHtml}</td>
        <td>${issues}</td>
        <td>
          <button class="btn btn-ghost btn-sm" onclick="auditOne(${b.id})">üîç</button>
          <button class="btn btn-danger btn-sm" onclick="deleteBiz(${b.id},this)">‚úï</button>
        </td>
      </tr>`;
    }).join('');
  }

  function renderPagination(total, current) {
    const pages = Math.ceil(total / PAGE_SIZE);
    if (pages <= 1) { document.getElementById('pagination').innerHTML = ''; return; }
    let html = '';
    if (current > 0) html += `<button class="page-btn" onclick="loadBusinesses(${current - 1})">‚Äπ Prev</button>`;

    const start = Math.max(0, current - 2);
    const end   = Math.min(pages - 1, current + 2);
    for (let i = start; i <= end; i++) {
      html += `<button class="page-btn ${i===current?'current':''}" onclick="loadBusinesses(${i})">${i+1}</button>`;
    }
    if (current < pages - 1) html += `<button class="page-btn" onclick="loadBusinesses(${current + 1})">Next ‚Ä∫</button>`;
    html += `<span class="page-info">${total.toLocaleString()} results ¬∑ Page ${current+1}/${pages}</span>`;
    document.getElementById('pagination').innerHTML = html;
  }

  // ‚îÄ‚îÄ Audit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function auditOne(id) {
    try {
      toast('Auditing website‚Ä¶');
      const result = await api(`/audits/business/${id}`, { method: 'POST' });
      toast(`‚úÖ Score: ${result.score} ‚Äî ${result.issues?.join(', ') || 'No issues detected'}`);
      loadBusinesses(currentPage);
    } catch(e) { toast('‚ùå Audit failed: ' + e.message); }
  }

  async function auditAll() {
    try {
      const r = await api('/audits', { method: 'POST' });
      toast('‚úÖ ' + r.message);
    } catch(e) { toast('‚ùå ' + e.message); }
  }

  // ‚îÄ‚îÄ Delete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function deleteBiz(id, btn) {
    if (!confirm('Remove this business?')) return;
    try {
      btn.closest('tr').style.opacity = '.4';
      await api('/businesses/' + id, { method: 'DELETE' });
      loadBusinesses(currentPage);
      toast('Removed.');
    } catch(e) { toast('‚ùå ' + e.message); btn.closest('tr').style.opacity = '1'; }
  }

  // ‚îÄ‚îÄ Bulk Scrape ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toggleAll(containerId, checked, limit = null) {
    const boxes = [...document.querySelectorAll(`#${containerId} input[type=checkbox]`)];
    boxes.forEach((cb, i) => { cb.checked = checked && (limit === null || i < limit); });
    updateBulkEstimate();
  }

  function updateBulkEstimate() {
    const cities = document.querySelectorAll('#bulk-cities input:checked').length;
    const cats   = document.querySelectorAll('#bulk-cats input:checked').length;
    const pages  = parseInt(document.getElementById('bulk-pages')?.value || 2);
    const est    = cities * cats * pages * 10;
    document.getElementById('bulk-estimate').textContent = `Estimated: ~${est.toLocaleString()} businesses (${cities} cities √ó ${cats} categories √ó ${pages} pages)`;
  }

  async function runBulkScrape() {
    const cities     = [...document.querySelectorAll('#bulk-cities input:checked')].map(cb => cb.value);
    const categories = [...document.querySelectorAll('#bulk-cats input:checked')].map(cb => cb.value);
    const pages      = parseInt(document.getElementById('bulk-pages').value);

    if (!cities.length)     { toast('Select at least one city'); return; }
    if (!categories.length) { toast('Select at least one category'); return; }
    if (cities.length * categories.length > 200) { toast('Too many combinations (max 200). Reduce selection.'); return; }

    const btn = document.getElementById('bulk-btn-text');
    btn.innerHTML = '<span class="spinner"></span> Queuing‚Ä¶';

    try {
      const r = await api('/scrape_jobs/bulk', {
        method: 'POST',
        body: JSON.stringify({ cities, categories, pages_per_combo: pages })
      });
      toast(`‚úÖ ${r.message}`);
      loadJobs('scrape-jobs-list');
      loadJobs('jobs-list');
    } catch(e) {
      toast('‚ùå ' + e.message);
    } finally {
      btn.textContent = '‚ö° Start Bulk Scrape';
    }
  }

  async function runBackfill() {
    const btn = document.getElementById('backfill-btn-text');
    btn.innerHTML = '<span class="spinner"></span> Queuing‚Ä¶';
    try {
      const r = await api('/scrape_jobs/backfill', { method: 'POST' });
      toast('‚úÖ ' + r.message);
      loadJobs('scrape-jobs-list');
      loadJobs('jobs-list');
    } catch(e) {
      toast('‚ùå ' + e.message);
    } finally {
      btn.textContent = 'üìû Backfill Phone & Website';
    }
  }

  // ‚îÄ‚îÄ Scraping ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openScrapeModal() { document.getElementById('scrape-modal').classList.remove('hidden'); }
  function closeScrapeModal() { document.getElementById('scrape-modal').classList.add('hidden'); }

  async function _doScrape(category, location, sourceContainerId) {
    const sources = [...document.querySelectorAll(`#${sourceContainerId} input[type=checkbox]:checked`)]
      .map(cb => cb.value);
    if (!sources.length) { toast('Select at least one source'); return; }

    try {
      const r = await api('/scrape_jobs', {
        method: 'POST',
        body: JSON.stringify({ sources, category, location })
      });
      toast(`‚úÖ Queued ${r.jobs.length} scrape job(s)`);
      loadJobs('jobs-list');
      loadJobs('scrape-jobs-list');
      return true;
    } catch(e) { toast('‚ùå ' + e.message); return false; }
  }

  async function runScrape() {
    const btn = document.getElementById('scrape-btn-text');
    btn.innerHTML = '<span class="spinner"></span> Starting‚Ä¶';
    await _doScrape(
      document.getElementById('sc-category').value,
      document.getElementById('sc-location').value,
      'sc-sources'
    );
    btn.textContent = '‚ñ∂ Start Scrape';
    loadJobs('scrape-jobs-list');
  }

  async function runModalScrape() {
    const ok = await _doScrape(
      document.getElementById('m-category').value,
      document.getElementById('m-location').value,
      'm-sources'
    );
    if (ok) closeScrapeModal();
  }

  // ‚îÄ‚îÄ Export PDF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function exportPdf() {
    try {
      toast('Generating PDF‚Ä¶');
      const params = new URLSearchParams();
      ['f-city','f-province','f-source','f-quality','f-website','f-min-score'].forEach(id => {
        const el = document.getElementById(id);
        if (el?.value) {
          const keyMap = { 'f-city':'city','f-province':'province','f-source':'source',
                          'f-quality':'quality','f-website':'website','f-min-score':'min_score' };
          params.append(keyMap[id], el.value);
        }
      });
      const blob = await api('/export/pdf?' + params.toString());
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url; a.download = `prospectr_sa_${new Date().toISOString().slice(0,10)}.pdf`;
      a.click(); URL.revokeObjectURL(url);
      toast('‚úÖ PDF downloaded!');
    } catch(e) { toast('‚ùå PDF failed: ' + e.message); }
  }

  // ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadSettings() {
    try {
      const s = await api('/settings');
      document.getElementById('s-google-key').value   = s.google_places_api_key || '';
      document.getElementById('s-province').value     = s.default_province      || 'Western Cape';
      document.getElementById('s-city').value         = s.default_city          || 'Cape Town';
      document.getElementById('s-category').value     = s.default_category      || 'restaurant';
      document.getElementById('s-concurrency').value  = s.audit_concurrency     || '5';
    } catch(e) { toast('Failed to load settings'); }
  }

  async function saveSettings() {
    try {
      await api('/settings', {
        method: 'PATCH',
        body: JSON.stringify({
          google_places_api_key: document.getElementById('s-google-key').value,
          default_province:      document.getElementById('s-province').value,
          default_city:          document.getElementById('s-city').value,
          default_category:      document.getElementById('s-category').value,
          audit_concurrency:     document.getElementById('s-concurrency').value
        })
      });
      toast('‚úÖ Settings saved!');
    } catch(e) { toast('‚ùå ' + e.message); }
  }

  // ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function scoreClass(s) { return s >= 70 ? 'score-high' : s >= 40 ? 'score-medium' : 'score-low'; }
  function truncate(s, n) { return s?.length > n ? s.slice(0, n) + '‚Ä¶' : s || ''; }
  function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function sourceLabel(s) {
    return { yellow_pages:'Yellow Pages', brabys:'Brabys', google_places:'Google Places', cipc:'CIPC' }[s] || s;
  }
  function timeAgo(iso) {
    if (!iso) return '';
    const sec = Math.round((Date.now() - new Date(iso)) / 1000);
    if (sec < 60)   return `${sec}s ago`;
    if (sec < 3600) return `${Math.round(sec/60)}m ago`;
    if (sec < 86400) return `${Math.round(sec/3600)}h ago`;
    return `${Math.round(sec/86400)}d ago`;
  }

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  updateBulkEstimate();
  loadStats();
  loadJobs();
</script>
</body>
</html>
